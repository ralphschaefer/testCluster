<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
		<title>Websocket</title>
	</head>
	<body>
		<label for="msg">Message: </label>
		<input type="text" id="msg">
		<button onclick="sendMsg(); return false;">Send to All</button>
		<br>
		<br>
		<textarea id="messagesTextArea" rows="10" cols="50"></textarea>
		<script src="/assets/javascripts/jquery-3.3.1.min.js" type="text/javascript"></script>
		<script type="text/javascript">

			var webSocket;

			jQuery.get("/hasListeners", function(data) {
				if (! data.hasSubscription) {
					webSocket = new WebSocket("ws://localhost:9000/listen");
					webSocket.onopen = function(message) { processOpen(message); };
					webSocket.onclose = function(message) { processClose(message); };
					webSocket.onerror = function(message) { processError(message); };
					webSocket.onmessage = function(message) { processMessage(message); };
					console.log("websocket connected");
				}
				else console.log("websocket not connected (used by an other client)");
			});

			var messagesTextArea = document.getElementById("messagesTextArea");

			messagesTextArea.scrollTop = messagesTextArea.scrollHeight

			function processOpen(message){
				messagesTextArea.value += "Server connect..." + JSON.stringify(message) + "\n";
				messagesTextArea.scrollTop = messagesTextArea.scrollHeight
			}

			function processClose(message) {
				webSocket.send("client disconnected");
				messagesTextArea.value += "Server Disconnect..." + JSON.stringify(message) + "\n";
				messagesTextArea.scrollTop = messagesTextArea.scrollHeight
			}

			function processError(message){
				messagesTextArea.value += "error " + JSON.stringify(message) + "\n"
				messagesTextArea.scrollTop = messagesTextArea.scrollHeight
			}

			function processMessage(message){
				messagesTextArea.value += message.data + "\n" + "____________________________\n\n";
				messagesTextArea.scrollTop = messagesTextArea.scrollHeight
			}

			
			function sendMsg() {
				var msg = document.getElementById("msg").value;
				document.getElementById("msg").value = "";

				var msgObject = {
					msg: msg
				};

				webSocket.send(JSON.stringify(msgObject));
			}
		</script>

	</body>
</html>